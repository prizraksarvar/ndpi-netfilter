--- /Users/asdasdsdsadsada/CLionProjects/ndpi-netfilter/nDPI//src/lib/protocols/netflow.c	2024-03-07 20:14:42
+++ /Users/asdasdsdsadsada/CLionProjects/ndpi-netfilter/nDPI-patch//src/lib/protocols/netflow.c	2024-03-08 08:00:43
@@ -24,11 +24,17 @@
 
 #include "ndpi_api.h"
 
-
 #ifdef WIN32
-extern int gettimeofday(struct timeval * tp, struct timezone * tzp);
+extern int gettimeofday(struct pkt_timeval * tp, struct timezone * tzp);
 #endif
-#define do_gettimeofday(a) gettimeofday(a, NULL)
+// See https://community.asterisk.org/t/cant-compile-dahdi-anymore-kernel-5-0-3-200-fc29-x86-64/79140/6
+static void do_gettimeofday(struct pkt_timeval *tv)
+{
+    struct timespec64 ts;
+    ktime_get_real_ts64(&ts);
+    tv->tv_sec = ts.tv_sec;
+    tv->tv_usec = ts.tv_nsec;
+}
 
 struct flow_ver1_rec {
   u_int32_t srcaddr;    /* Source IP Address */
@@ -103,7 +109,7 @@
   // const u_int8_t *packet_payload = packet->payload;
   u_int32_t payload_len = packet->payload_packet_len;
   time_t now;
-  struct timeval now_tv;
+  struct pkt_timeval now_tv;
 
   NDPI_LOG_DBG(ndpi_struct, "search netflow\n");
 
